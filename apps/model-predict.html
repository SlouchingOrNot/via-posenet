<!DOCTYPE html>
<style media="screen">
	body {
		text-align: center;
		background-color: #ccc;
	}
</style>

<body>
	<!-- links in page header -->
	<a href='' onclick='location.href = `dataset-build.html${location.hash}`; event.preventDefault();'>build</a> -
	<a href='' onclick='location.href = `dataset-view.html${location.hash}`; event.preventDefault();'>view</a> -
	<a href='' onclick='location.href = `model-learn.html${location.hash}`; event.preventDefault();'>learn</a> -
	<a href='' onclick='location.href = `model-predict.html${location.hash}`; event.preventDefault();'>predict</a>
	<br /><br /><br />


	<video id='sourceVideo' playsinline style=' -moz-transform: scaleX(-1);
	        -o-transform: scaleX(-1);
	        -webkit-transform: scaleX(-1);
	        transform: scaleX(-1);
		display: none;
	        '>
	</video>

	<h2><span id='bestClassNameID'>Loading...</h2>

	<div>
		<label title='yes if posenetResult is considered good enough to be feed into AI. If not good enough, it is considered as not slouching'>Good
			Enough for AI :
			<span id='posenetResultGoodEnoughID'></span>
		</label>
	</div>
	<div>
		<label title='yes if we considere seeing a person in the video'>Found person present in video:
			<span id='isSeeingSomeoneID'></span>
		</label>
	</div>
	<div>
		<label title='How sure are we of the prediction'>Prediction Confidence:
			<span id='predictionConfidenceID'></span>
		</label>
	</div>


	<div id='videosContainerID' style='height: 448px'></div>

	<div>
		<label>Options
			<input type="checkbox" id="optionsToggleID"></input>
		</label>
		
	</div>
        <div>
		<label>Mute
			<input type="checkbox" id="muteID" title='To mute the sound or not.' checked/>
		</label>
	</div>	
	<div id='optionsID' style='display:none'>
		<div>
			<label>Display posenet result
				<input type="checkbox" id="posenetResultEnableID" checked></input>
			</label>
		</div>

		<br />

		<!-- element to contained the featureVectorHeatmapsID -->
		<h3>Camera Calibration</h3>
		<div>
			<label>PosenetResult offset Y :</label>
			<input type="range" id="posenetOffsetYRangeID" min="-112" max="+112" value='-15' title='PosenetResult offset Y' />
			<label id='posenetOffsetYLabelID'>-15</label>
		</div>
		<br />
		<h3>Dataset Heatmap</h3>
		<!-- UI to select the dataset-info url -->
		<label>Dataset:
			<select id='datasetNameID'>
				<option value='low-isSlouching__high-notSlouching'>low-isSlouching__high-notSlouching</option>
				<option value='low-isSlouching__middle-notSlouching'>low-isSlouching__middle-notSlouching</option>
			</select>
		</label>

		<!-- UI to select the augmentation policy -->
		<label>Augmentation Policy:
			<select id='augmentationPolicyID'>
				<!-- options for augmentationPolicy -->
			</select>
		</label>
		<br />
		<br />
		<br />
		<div id='featureVectorHeatmapsID'>
			<span>isSlouching</span>
			<span class='featureVectorHeatmap-isSlouching' style='position: relative'></span>
			<span>notSlouching</span>
			<span class='featureVectorHeatmap-notSlouching' style='position: relative'></span>
		</div>

		<br />
		<!-- display datasetRaw summaries -->
		<div id='datasetRawSumaries'></div>

	</div>
</body>

<!-- Load TensorFlow.js -->
<!-- <script src='https://unpkg.com/@tensorflow/tfjs'></script> -->
<script src='vendor/tensorflow.min.js'></script>
<!-- Load Posenet -->
<!-- <script src='https://unpkg.com/@tensorflow-models/posenet'></script> -->
<script src='vendor/tfjs-model-posenet.min.js'></script>

<!-- Load ml-posenet.js - https://github.com/SlouchingOrNot/ml-posenet -->
<script src='./vendor/ml-posenet.js'></script>

<!-- Load simpleheat.js for heatmap -->
<script src="vendor/simpleheat.js"></script>

<!-- Place your code in the script tag below. You can also use an external .js file -->
<script type='module'>
	// import mlPosenet from '../../contribs/ml-posenet/src/index.js'

	import DatasetInfo from '../src/dataset-info.js'
	import DatasetRaw from '../src/dataset-raw.js';
	import DatasetProcessing from '../src/dataset-processing.js'
	import DatasetAugmentation from '../src/dataset-augmentation.js';
	import DatasetFeature from '../src/dataset-feature.js'
	import ModelIO from '../src/model-io.js';
	import ModelConstants from '../src/model-constants.js'

	(async function () {
		let cst = ModelConstants
		var urlParams = new URLSearchParams(window.location.hash.substr(1))

		////////////////////////////////////////////////////////////////////////
		//		Handle optionsID UI
		////////////////////////////////////////////////////////////////////////
		document.querySelector('#optionsToggleID').addEventListener('change', (event) => {
			let checked = document.querySelector('#optionsToggleID').checked
			document.querySelector('#optionsID').style.display = checked ? 'block' : 'none'
		})

		////////////////////////////////////////////////////////////////////////
		//		Handle #posenetOffsetYLabelID
		////////////////////////////////////////////////////////////////////////
		document.querySelector('#posenetOffsetYRangeID').addEventListener("input", function () {
			var value = document.querySelector('#posenetOffsetYRangeID').value
			document.querySelector('#posenetOffsetYLabelID').innerHTML = value
		}, false);

		//////////////////////////////////////////////////////////////////////////////
		//		load dataset-info
		//////////////////////////////////////////////////////////////////////////////
		var datasetName = urlParams.get('datasetName') || 'low-isSlouching__middle-notSlouching'
		var datasetInfoURL = `../datasets/${datasetName}/dataset-info.json`
		var datasetInfo = await DatasetInfo.load(datasetInfoURL)

		// set #datasetNameID value
		document.querySelector('#datasetNameID').value = datasetName

		// handle #datasetNameID change
		document.querySelector('#datasetNameID').addEventListener('change', function () {
			urlParams.set('datasetName', this.value);
			location.hash = `#${urlParams.toString()}`
			location.reload()
		})

		//////////////////////////////////////////////////////////////////////////////
		//		load DatasetRaw
		//////////////////////////////////////////////////////////////////////////////
		console.time('loadingData')
		let datasetRaw = new DatasetRaw(cst.NUM_CLASSES)
		for (let classIndex = 0; classIndex < cst.NUM_CLASSES; classIndex++) {
			await datasetRaw.loadClass(classIndex, datasetInfo.posenetResultURLs[classIndex], datasetInfo.imageURLs[classIndex])
		}
		console.timeEnd('loadingData')
		datasetRaw.print('raw data')

		//////////////////////////////////////////////////////////////////////////////
		//		remove not isGoodEnough samples from datasetRaw
		//////////////////////////////////////////////////////////////////////////////

		datasetRaw = DatasetProcessing.removeNotGoodEnoughSamples(datasetRaw)

		//////////////////////////////////////////////////////////////////////////////
		//		balance datasetRaw
		//////////////////////////////////////////////////////////////////////////////

		DatasetProcessing.balanceDatasetRaw(datasetRaw)

		//////////////////////////////////////////////////////////////////////////////
		//		Augment datasetRaw
		//////////////////////////////////////////////////////////////////////////////

		// get current augmentationPolicy
		let augmentationPolicy = urlParams.get('augmentationPolicy') || 'massiveAugmentation2'

		// augment datasetRaw
		datasetRaw = DatasetAugmentation.augmentDatasetRaw(datasetRaw, augmentationPolicy)
		datasetRaw.print('after augmentation data')

		// build option for augmentationPolicyID
		var augmentationPolicies = Object.keys(DatasetAugmentation.registeredAugmentations)
		augmentationPolicies.forEach((augmentationPolicy) => {
			var domElement = document.createElement('option')
			domElement.value = augmentationPolicy
			domElement.innerHTML = augmentationPolicy
			document.querySelector('#augmentationPolicyID').appendChild(domElement)
		})

		// set #augmentationPolicyID value
		document.querySelector('#augmentationPolicyID').value = augmentationPolicy

		// handle #augmentationPolicyID change
		document.querySelector('#augmentationPolicyID').addEventListener('change', function () {
			urlParams.set('augmentationPolicy', this.value);
			location.hash = `#${urlParams.toString()}`
			location.reload()
		})

		//////////////////////////////////////////////////////////////////////////////
		//		remove any tilt in datasetRaw posenetResult keypoints
		//////////////////////////////////////////////////////////////////////////////

		datasetRaw = DatasetProcessing.removeTiltDatasetRaw(datasetRaw)

		//////////////////////////////////////////////////////////////////////////////
		//		create featureVector heatmap
		//////////////////////////////////////////////////////////////////////////////

		for (let classIndex = 0; classIndex < cst.NUM_CLASSES; classIndex++) {
			// build canvasEl
			let canvasEl = document.createElement('canvas')
			canvasEl.width = canvasEl.height = 256
			canvasEl.style.border = 'gray solid 1px'
			document.querySelector(`#featureVectorHeatmapsID .featureVectorHeatmap-${ModelConstants.CLASS_NAMES[classIndex]}`).appendChild(canvasEl)
			// build featureVectors
			let featureVectors = []
			for (let sampleIndex = 0; sampleIndex < datasetRaw.posenetResults[classIndex].length; sampleIndex++) {
				let posenetResult = datasetRaw.posenetResults[classIndex][sampleIndex]
				// if (DatasetProcessing.posenetResultGoodEnoughToLearn(posenetResult) === false) continue

				var featureVector = DatasetFeature.createFeatureVector(posenetResult)
				featureVectors.push(featureVector)
			}
			// draw heat map
			// DatasetFeature.drawHeatMapCanvas(canvasEl, featureVectors)

			let simpleHeatmap = simpleheat(canvasEl)
			simpleHeatmap.radius(1, 5);
			simpleHeatmap.max(Math.log(featureVectors.length) / 3)
			for (let vectorIndex = 0; vectorIndex < featureVectors.length; vectorIndex++) {
				for (let featureIndex = 0; featureIndex < featureVectors[0].length; featureIndex++) {
					var feature = featureVectors[vectorIndex][featureIndex]
					simpleHeatmap.add([feature[0] * canvasEl.width, feature[1] * canvasEl.height, 1])
				}
			}
			simpleHeatmap.draw();
		}


		// build canvas for current feature vector feedback
		let isSlouchingFeatureHeatmapEl = document.createElement('canvas')
		isSlouchingFeatureHeatmapEl.width = isSlouchingFeatureHeatmapEl.height = 256
		isSlouchingFeatureHeatmapEl.style.position = 'absolute'
		isSlouchingFeatureHeatmapEl.style.left = '0px'
		document.querySelector('#featureVectorHeatmapsID .featureVectorHeatmap-isSlouching').appendChild(isSlouchingFeatureHeatmapEl)
		let notSlouchingFeatureHeatmapEl = document.createElement('canvas')
		notSlouchingFeatureHeatmapEl.width = notSlouchingFeatureHeatmapEl.height = 256
		notSlouchingFeatureHeatmapEl.style.position = 'absolute'
		notSlouchingFeatureHeatmapEl.style.left = '0px'
		document.querySelector('#featureVectorHeatmapsID .featureVectorHeatmap-notSlouching').appendChild(notSlouchingFeatureHeatmapEl)

		//////////////////////////////////////////////////////////////////////////////
		//		load dataset-info
		//////////////////////////////////////////////////////////////////////////////
		try {
			var videoEl = await mlPosenet.Utils.setupCamera()
		} catch (myException) {
			alert(`cant find web camera due to "${myException.message}"`)
		}

		const canvasEl = document.createElement('canvas')
		canvasEl.width = canvasEl.height = 224;
		canvasEl.style.zoom = 2
		document.querySelector('#videosContainerID').append(canvasEl)
		var posenetViewer = new mlPosenet.ResultsViewer(canvasEl)

		const posenetParameters = mlPosenet.Parameters.Sample

		//////////////////////////////////////////////////////////////////////////////
		//		Load posenet model
		//////////////////////////////////////////////////////////////////////////////

		console.log('Loading models...')
		let loadingStart = performance.now()
		let posenetModel = await posenet.load(+posenetParameters.input.mobileNetArchitecture)
		let loadingTime = performance.now() - loadingStart
		console.log(`models loaded in ${loadingTime.toFixed(2)} msec`)

		//////////////////////////////////////////////////////////////////////////////
		//		load slouching model
		//////////////////////////////////////////////////////////////////////////////
		let modelURL = 'indexeddb://slouchingOrNot-model-tensorflowjs'
		let modelIO = new ModelIO(modelURL)
		let slouchingModel = await modelIO.load()
		slouchingModel.summary()

		//////////////////////////////////////////////////////////////////////////////
		//		loop requestAnimationFrame
		//////////////////////////////////////////////////////////////////////////////
		let smoothedPosenetResult = null
		requestAnimationFrame(async function callback() {
			//////////////////////////////////////////////////////////////////////////////
			//		Estimate Pose
			//////////////////////////////////////////////////////////////////////////////
			// console.log('estimating poses...')
			let startingTime = performance.now()
			let posenetResult = await mlPosenet.Utils.estimatePoses(videoEl, posenetModel, posenetParameters)
			let estimationTime = performance.now() - startingTime
			// console.log(`Poses estimated in ${estimationTime.toFixed(2)} ms`)

			// apply lerp on posenetResult
			if (smoothedPosenetResult === null) smoothedPosenetResult = DatasetProcessing.clonePosenetResult(posenetResult)
			DatasetProcessing.lerpPosenetResult(smoothedPosenetResult, smoothedPosenetResult, posenetResult, 0.5)
			posenetResult = DatasetProcessing.clonePosenetResult(smoothedPosenetResult)

			// visualize posenetResult for debug
			posenetParameters.output.showPoints = document.querySelector('#posenetResultEnableID').checked
			posenetParameters.output.showSkeleton = document.querySelector('#posenetResultEnableID').checked
			posenetViewer.update(posenetResult, videoEl, posenetParameters)

			//////////////////////////////////////////////////////////////////////////////
			//		Canonize posenetResult
			//////////////////////////////////////////////////////////////////////////////

			// remove the tilt on this posenetResult
			DatasetProcessing.removeTiltPosenetResult(posenetResult)

			// apply posenetOffsetY
			var posenetOffsetY = parseFloat(document.querySelector('#posenetOffsetYRangeID').value)
			DatasetProcessing.translateFixKeypointPositions(posenetResult, 0, posenetOffsetY)

			//////////////////////////////////////////////////////////////////////////////
			//		Convert to featureVector and do a prediction
			//////////////////////////////////////////////////////////////////////////////

			// createa a featureVector
			let featureVector = DatasetFeature.createFeatureVector(posenetResult)

			// filter posenetResult when they are not "good enough"
			var isGoodEnough = DatasetProcessing.posenetResultGoodEnoughToLearn(posenetResult)
			if (isGoodEnough === true) {
				// predict the class based on this featureVector
				const inputTensor = tf.tensor3d([featureVector]);
				const predictions = slouchingModel.predict(inputTensor)
				var predictionsData = await predictions.data()
				predictions.dispose()
			} else {
				// if not 'good enough', then assume notSlouching
				var predictionsData = new Array(cst.NUM_CLASSES)
				predictionsData[cst.CLASS_INDEXES.isSlouching] = 0
				predictionsData[cst.CLASS_INDEXES.notSlouching] = 1
			}


			//////////////////////////////////////////////////////////////////////////////
			//                process predictions
			//////////////////////////////////////////////////////////////////////////////

			// compute rawBestClass
			let rawBestClass = 0
			for (let classIndex = 0; classIndex < predictionsData.length; classIndex++) {
				if (predictionsData[classIndex] > predictionsData[rawBestClass]) {
					rawBestClass = classIndex
				}
			}

			////////////////////////////////////////////////////////////////////////
			//		Update UI
			////////////////////////////////////////////////////////////////////////

			// honor isGoodEnough UI
			if (isGoodEnough === true) {
				document.querySelector('#posenetResultGoodEnoughID').innerHTML = 'yes'
			} else {
				document.querySelector('#posenetResultGoodEnoughID').innerHTML = '<span style="color:red;">NO</span>'
			}

			// honor isSeeingSomeoneID
			var isSeeingSomeone = DatasetProcessing.posenetResultIsSeeingSomeone(posenetResult)
			if (isSeeingSomeone === true) {
				document.querySelector('#isSeeingSomeoneID').innerHTML = 'yes'
			} else {
				document.querySelector('#isSeeingSomeoneID').innerHTML = '<span style="color:red;">NO</span>'
			}

			// update isSlouchingFeatureHeatmapEl
			for (let canvasEl of [isSlouchingFeatureHeatmapEl, notSlouchingFeatureHeatmapEl]) {
				let context = canvasEl.getContext('2d')
				context.clearRect(0, 0, canvasEl.width, canvasEl.height);
				DatasetFeature.drawOneFeatureVector(context, featureVector)
			}

			// display result
			document.querySelector('#bestClassNameID').innerHTML = cst.CLASS_NAMES[rawBestClass]
			if (rawBestClass === cst.CLASS_INDEXES.isSlouching) {
				document.querySelector('#bestClassNameID').style.color = 'red'
			} else {
				document.querySelector('#bestClassNameID').style.color = ''
			}

			document.querySelector('#predictionConfidenceID').innerHTML = `${Math.round(predictionsData[rawBestClass] * 100)}%`

			//////////////////////////////////////////////////////////////////////////////
			//		Notify CustomEvent for slouchingOrNotEvent
			//////////////////////////////////////////////////////////////////////////////
			window.dispatchEvent(new CustomEvent("slouchingOrNotEvent", {
				detail: {
					type: 'rawPrediction',
					rawBestClass: rawBestClass,
					rawConfidence: predictionsData[rawBestClass],
					isGoodEnough: isGoodEnough,
					isSeeingSomeone: isSeeingSomeone,
				}
			}))

			//////////////////////////////////////////////////////////////////////////////
			//		Loop requestAnimationFrame
			//////////////////////////////////////////////////////////////////////////////

			// NOTE: it MUST be at the end, as it is a async function
			requestAnimationFrame(callback)
		})



	})()
</script>

<script type='module' src="predict-ui-plugins/predict-event-helpers.js"></script>
<script type='module' src="predict-ui-plugins/predict-event-sounds.js"></script>