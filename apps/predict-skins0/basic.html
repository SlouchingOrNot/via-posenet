<style media='screen'>
        body {
                margin: 0px;
                text-align: center;
        }

        iframe {
                width: 100%;
                height: 100%;
                /* border: 0px; */
                /* display: none; */
        }
</style>

<body>
        <h2 id='bestClassNameID'>Loading...</h2>

        <div>
		<label>Result Smoothing over n samples</label>
		<input type="number" id="resultSmoothingID" min="1" max="300" value='1' title='number of result over which we smooth the detection'/>
	</div>
        <div>
		<label>Mute
			<input type="checkbox" id="muteID" title='To mute the sound or not.'/>
		</label>
	</div>

	<br/><br/><br/><br/><br/><br/>

	<!-- include model-predict.html iframe -->
        <iframe src='../model-predict.html#augmentationPolicy=massiveAugmentation2&datasetName=low-isSlouching__middle-notSlouching'></iframe>


<script>
// FIXME this is duplication model-constant.js ... why am i doing that ??? 
let CLASS_NAMES = ['isSlouching', 'notSlouching']
const CLASS_INDEXES = {
	isSlouching : CLASS_NAMES.indexOf('isSlouching'),
	notSlouching : CLASS_NAMES.indexOf('notSlouching'),
}



/**
 * Send a message to the child iframe
 */
function sendMessage(message) {
	let iframeEl = document.querySelector('iframe')
	iframeEl.contentWindow.postMessage(message, '*');
}

// to receive message
let bestClassesHistory = []
let lastBestClass = null
window.addEventListener("message", function onWindowMessage(event) {
	let eventData = event.data
	let rawBestClass = event.data.rawBestClass
	// console.log(`rawBestClass ${eventData.rawBestClass}. isGoodEnougth ${eventData.isGoodEnough}`)

	// update bestClassesHistory
	bestClassesHistory.push(rawBestClass)
	var historyMaxLength = parseInt(document.querySelector('#resultSmoothingID').value)
	while( bestClassesHistory.length > historyMaxLength ){
		bestClassesHistory.shift()
	}

	// compute smoothedBestClass
	var smoothedBestClass = 0
	for(let i = 0; i < bestClassesHistory.length; i++){
		smoothedBestClass += bestClassesHistory[i]
	}
	smoothedBestClass /= bestClassesHistory.length
	smoothedBestClass = Math.round(smoothedBestClass)


	////////////////////////////////////////////////////////////////////////
	//	handle onBestClassChange
	////////////////////////////////////////////////////////////////////////
	
	if( smoothedBestClass !== lastBestClass ){
		onBestClassChange(smoothedBestClass, lastBestClass)
	}
	lastBestClass = smoothedBestClass

	////////////////////////////////////////////////////////////////////////
	//	Display bestClassName
	////////////////////////////////////////////////////////////////////////

	let bestClassName = CLASS_NAMES[smoothedBestClass]
	document.querySelector('#bestClassNameID').innerHTML = bestClassName
	if (bestClassName === 'isSlouching') {
		document.querySelector('#bestClassNameID').style.color = 'red'
	} else {
		document.querySelector('#bestClassNameID').style.color = ''
	}
}, false);

/*
 * - make a smoother for rawBestClass
 * - make a detection of rawBestClass change
 * - if is in isSlouching for more than X seconds, then produce a sound periodically
 * - 
*/

function onBestClassChange(newBestClass, oldBestClass){
	// console.log(`newBestClass ${newBestClass}`)

	if( newBestClass === CLASS_INDEXES['isSlouching'] ){
		// playSound('sounds/265012__sethlind__toaster-oven-ding.wav', 0.05)
		// playSound('sounds/341601__mike-stranks__gentle-stream.wav', 0.3)
		playSound('sounds/351167__reitanna__that-s-bad.wav', 0.3)
	}

	if( newBestClass === CLASS_INDEXES['notSlouching'] ){
		playSound('sounds/277021__sandermotions__applause-2.wav', 0.1)
	}
}

////////////////////////////////////////////////////////////////////////
//	handle notification sounds
////////////////////////////////////////////////////////////////////////

var notificationAudioEl = null

/**
 * Play a sound notification.
 */
function playSound(soundURL, volume) {
	// honor the muteID UI
	let shouldBeMuted = document.querySelector('#muteID').checked ? true : false
	if( shouldBeMuted === true ){
		volume = 0
	}

	// stop currently playing sound if any
	if( notificationAudioEl !== null ){
		notificationAudioEl.pause()
		notificationAudioEl = null
	}

	// create the new audio element 
	var audioEl = new Audio(soundURL);
	audioEl.volume = volume
	audioEl.play();

	// once the sound is ended, set notificationAudioEl to null
	audioEl.addEventListener('ended', function(){
		notificationAudioEl.pause()
		notificationAudioEl = null
	})

	// update notificationAudioEl
	notificationAudioEl = audioEl
}


document.querySelector('#muteID').addEventListener('change', function(){
	// if no sound is in progress, return now
	if( notificationAudioEl === null )	return

	let shouldBeMuted = document.querySelector('#muteID').checked ? true : false
	notificationAudioEl.muted = shouldBeMuted
})

</script>

</body>
